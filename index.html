<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Warnow Moments – Verfügbarkeit</title>
  <style>
    :root{
      --font: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      --fs-base: 16px;
      --lh-base: 1.45;

      --fs-h1: 34px;
      --lh-h1: 1.12;

      --fs-label: 15px;
      --fs-ui: 16px;
      --fs-muted: 14px;

      --fw-regular: 500;
      --fw-strong: 800;

      --c-text: #0f172a;
      --c-muted: #4b5563;
      --c-border: #e5e7eb;
      --c-bg-pill: #f3f4f6;
      --c-primary: #1d334a;
      --c-error: #b91c1c;

      --c-res: #ef6c00;
      --c-conf: #1b5e20;

      --radius: 12px;
      --radius-btn: 10px;
      --pad: 14px;
    }

    *, *::before, *::after { box-sizing: border-box; }

    body{
      font-family: var(--font);
      font-size: var(--fs-base);
      line-height: var(--lh-base);
      color: var(--c-text);
      margin:0;
      padding:16px;
      max-width:980px;
      /* Verhindert horizontales Scrollen im iFrame */
      overflow-x: hidden; 
    }

    h1{
      margin:0 0 10px;
      font-size: var(--fs-h1);
      line-height: var(--lh-h1);
      letter-spacing: -0.02em;
    }

    .card{
      border:1px solid var(--c-border);
      border-radius: var(--radius);
      padding: var(--pad);
      margin:10px 0;
      background: #fff;
    }

    label{
      display:block;
      font-weight: var(--fw-strong);
      margin:10px 0 6px;
      font-size: var(--fs-label);
    }

    select,input[type="text"],input[type="email"],input[type="tel"],input[type="date"],button,textarea{ 
      font: inherit; 
    }

    select,input[type="text"],input[type="email"],input[type="tel"],input[type="date"],textarea{
      padding:10px;
      width:100%;
      max-width:100%;
      font-size: var(--fs-ui);
      border: 1px solid var(--c-border);
      border-radius: 10px;
      background: #fff;
      transition: border-color 0.2s;
    }
    
    /* Fokus und Fehler-Styling */
    select:focus,input:focus,textarea:focus {
      outline: 2px solid var(--c-primary);
      outline-offset: -1px;
    }
    .input-error {
      border-color: var(--c-error) !important;
      background-color: #fef2f2 !important;
    }

    select:disabled, input:disabled, textarea:disabled{
      background: #f8fafc;
      color: #6b7280;
    }

    textarea{
      min-height: 110px;
      resize: vertical;
    }

    .grid{
      display:grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr) minmax(0, 1fr);
      gap:12px;
      align-items:end;
    }
    .grid > div{min-width:0;}

    @media (max-width: 820px){
      :root{ --fs-h1: 28px; }
      .grid{grid-template-columns: 1fr;}
    }

    .btn, .btn2{
      display:inline-block;
      padding:10px 14px;
      border-radius: var(--radius-btn);
      border:1px solid var(--c-primary);
      text-decoration:none;
      font-weight: var(--fw-strong);
      font-size: var(--fs-ui);
      line-height: 1.1;
      cursor:pointer;
      background:#fff;
      color: var(--c-primary);
      transition: opacity 0.2s;
    }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn{ background: var(--c-primary); color:#fff; }

    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}

    .muted{
      color: var(--c-muted);
      font-size: var(--fs-muted);
      line-height: 1.35;
    }
    .error{
      color: var(--c-error);
      font-weight: var(--fw-strong);
      font-size: var(--fs-muted);
      line-height: 1.35;
    }
    .pill{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      background: var(--c-bg-pill);
      font-weight: var(--fw-strong);
      font-size: var(--fs-muted);
      line-height: 1.2;
    }
    .kv{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}

    .holiday-label{
      margin-top: 2px;
      font-size: 11px;
      line-height: 1.15;
      font-weight: 900;
      color: var(--c-primary);
      opacity: 0.95;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    .tl-wrap{
      border:1px solid var(--c-border);
      border-radius: 12px;
      padding:10px;
      background:#fff;
      margin-top:10px;
    }
    .tl-scale{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:12px;
      color: var(--c-muted);
      font-weight:800;
      margin-bottom:8px;
    }
    .tl-bar{
      position:relative;
      height:14px;
      border-radius:999px;
      background: linear-gradient(90deg, #f3f4f6, #eef2f7);
      overflow:hidden;
      border:1px solid var(--c-border);
    }
    .tl-block{
      position:absolute;
      top:0;
      bottom:0;
      border-radius:999px;
      opacity:0.95;
      cursor:pointer;
    }
    .tl-block.res{ background: var(--c-res); }
    .tl-block.conf{ background: var(--c-conf); }

    .tl-legend{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      margin-top:8px;
      font-size:12px;
      color: var(--c-muted);
      font-weight:800;
    }
    .tl-dot{
      width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px;
      transform: translateY(1px);
    }
    .tl-dot.res{ background: var(--c-res); }
    .tl-dot.conf{ background: var(--c-conf); }

    .tl-tip{
      position:absolute;
      z-index: 50;
      min-width: 220px;
      max-width: 280px;
      background:#fff;
      border:1px solid var(--c-border);
      border-radius: 12px;
      box-shadow: 0 18px 50px rgba(0,0,0,.18);
      padding:10px 12px;
      font-size: 13px;
      line-height: 1.25;
      color: var(--c-text);
      display:none;
    }
    .tl-tip.open{ display:block; }
    .tl-tip .t-title{ font-weight: 900; margin-bottom: 6px; }
    .tl-tip .t-row{ color: var(--c-muted); font-weight: 800; }
    .tl-tip .t-close{
      position:absolute;
      top:6px;
      right:6px;
      border:1px solid var(--c-border);
      background:#fff;
      border-radius: 10px;
      padding:4px 7px;
      font-weight: 900;
      cursor:pointer;
      line-height:1;
    }
    
    /* Checkbox Styling */
    .checkbox-row {
      display: flex;
      gap: 10px;
      align-items: flex-start;
      margin-top: 16px;
      margin-bottom: 8px;
    }
    .checkbox-row input[type="checkbox"] {
      margin-top: 3px;
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    .checkbox-row label {
      margin: 0;
      font-weight: var(--fw-regular);
      font-size: var(--fs-muted);
      color: var(--c-text);
      cursor: pointer;
    }
    .checkbox-row a {
      color: var(--c-primary);
      text-decoration: underline;
    }
  </style>
</head>
<body>

<h1>Verfügbarkeit & Reservierungsanfrage</h1>

<div class="card">
  <div class="grid">
    <div>
      <label for="date">Datum</label>
      <input id="date" type="date" required />
    </div>

    <div>
      <label for="package">Paket</label>
      <select id="package" required>
        <option value="4">Explorer‑Tour (4 Std.)</option>
        <option value="6">Halbtags‑Cruise (6 Std.)</option>
        <option value="8">Ganztags‑Abenteuer (8 Std.)</option>
      </select>
    </div>

    <div>
      <label for="start">Startzeit (volle Stunde)</label>
      <select id="start" required></select>
    </div>
  </div>

  <div class="kv">
    <span class="pill" id="selected-pill">Auswahl: –</span>
    <span class="muted" id="sunset-pill"></span>
    <span class="muted" id="public-pill"></span>
  </div>

  <p class="muted" id="hint" style="margin-top:10px"></p>
  <p class="error" id="err" style="display:none;margin-top:10px"></p>

  <div class="grid" style="margin-top:10px">
    <div>
      <label for="name">Name</label>
      <input id="name" type="text" autocomplete="name" placeholder="Max Mustermann" required />
    </div>
    <div>
      <label for="email">E‑Mail Adresse</label>
      <input id="email" type="email" autocomplete="email" placeholder="mail@beispiel.de" required />
    </div>
    <div>
      <label for="phone">Telefonnummer</label>
      <input id="phone" type="tel" autocomplete="tel" placeholder="0151 1234567" required />
    </div>
  </div>

  <div style="margin-top:2px">
    <label for="message">Nachricht</label>
    <textarea id="message" placeholder="Optional: z.B. Teilnehmerzahl, besondere Wünsche, Rückfragen …"></textarea>
  </div>

  <div class="checkbox-row" style="margin-top: 12px;">
    <input type="checkbox" id="copyCustomer" />
    <label for="copyCustomer">
      Bitte senden Sie mir eine Kopie dieser Anfrage an meine E-Mail-Adresse.
    </label>
  </div>

  <div class="checkbox-row" style="margin-top: 8px; margin-bottom: 12px;">
    <input type="checkbox" id="privacy" required />
    <label for="privacy">
      Ich stimme zu, dass meine Angaben aus dem Formular zur Beantwortung meiner Anfrage erhoben und verarbeitet werden. 
      Details entnehmen Sie unserer <a href="https://warnowmoments.de/datenschutz" target="_blank" rel="noopener">Datenschutzerklärung</a>.
    </label>
  </div>

  <div class="row">
    <button class="btn" id="cta" type="button">Reservierung anfragen</button>
    <a class="btn2" id="cta2" href="https://warnowmoments.de/contact" target="_blank" rel="noopener">
      Kontaktformular öffnen
    </a>
    <span class="muted" id="cta-status" aria-live="polite"></span>
  </div>

  <p class="muted" style="margin-top:12px">
    Hinweis: Bitte ca. 30 Minuten vor Start für Einweisung vor Ort sein. Rückgabe/Anlegen erfolgt nach der Fahrt (ca. 30 Minuten eingeplant).
  </p>
</div>

<div class="card">
  <h2 style="margin:0 0 10px;font-size:18px;line-height:1.2">Kalender</h2>

  <div class="row" style="justify-content:space-between;align-items:center">
    <div class="row">
      <button class="btn2" type="button" id="cal-prev" aria-label="Vorheriger Monat">←</button>
      <button class="btn2" type="button" id="cal-today">Heute</button>
      <button class="btn2" type="button" id="cal-next" aria-label="Nächster Monat">→</button>
    </div>
    <div class="pill" id="cal-title">–</div>
  </div>

  <div id="cal-grid" style="margin-top:12px"></div>

  <p class="muted" id="cal-day-title" style="margin-top:12px"></p>
  <div id="cal-slots" class="row" style="margin-top:8px;flex-wrap:wrap"></div>

  <div class="tl-wrap" id="cal-timeline-wrap" style="display:none">
    <div class="tl-scale" id="cal-timeline-scale"></div>

    <div class="tl-bar" id="cal-timeline-bar" aria-label="Belegungen als Zeitleiste">
      <div class="tl-tip" id="tl-tip" role="dialog" aria-modal="false" aria-label="Belegungsdetails">
        <button class="t-close" type="button" id="tl-tip-close" aria-label="Schließen">×</button>
        <div class="t-title" id="tl-tip-title">–</div>
        <div class="t-row" id="tl-tip-time">–</div>
        <div class="t-row" id="tl-tip-dur">–</div>
      </div>
    </div>

    <div class="tl-legend">
      <span><span class="tl-dot conf"></span>Gebucht</span>
      <span><span class="tl-dot res"></span>Reserviert</span>
    </div>
  </div>

  <p class="muted" id="cal-blocks-title" style="margin-top:12px"></p>
  <div id="cal-blocks" style="margin-top:6px"></div>

  <p class="muted" style="margin-top:12px">
    Tipp: Klick auf einen Tag zeigt freie Startzeiten für das ausgewählte Paket.
  </p>
</div>

<script>
(() => {
  const LAT = 54.0924;
  const LNG = 12.0991;

  const HOURS_MIN = 9;
  const HOURS_MAX = 18;

  const TL_START_HOUR = HOURS_MIN;
  const TL_END_HOUR = HOURS_MAX;

  const RETURN_BUFFER_MIN = 30;

  const PUBLIC_CAL_URL = "./wm_public_calendar.json";
  const BLOCK_STATUSES = new Set(["reserved","confirmed"]);

  const WORKERURL = "https://reservierung-v2.kontakt-70d.workers.dev/";

  // Elemente
  const dateEl = document.getElementById("date");
  const pkgEl = document.getElementById("package");
  const startEl = document.getElementById("start");
  const hintEl = document.getElementById("hint");
  const errEl = document.getElementById("err");
  const ctaEl = document.getElementById("cta");
  const ctaStatusEl = document.getElementById("cta-status");
  const selectedPillEl = document.getElementById("selected-pill");
  const sunsetPillEl = document.getElementById("sunset-pill");
  const publicPillEl = document.getElementById("public-pill");
  const nameEl = document.getElementById("name");
  const emailEl = document.getElementById("email");
  const phoneEl = document.getElementById("phone");
  const messageEl = document.getElementById("message");
  const privacyEl = document.getElementById("privacy");
  const copyCustomerEl = document.getElementById("copyCustomer");

  const calPrevEl = document.getElementById("cal-prev");
  const calNextEl = document.getElementById("cal-next");
  const calTodayEl = document.getElementById("cal-today");
  const calTitleEl = document.getElementById("cal-title");
  const calGridEl = document.getElementById("cal-grid");
  const calDayTitleEl = document.getElementById("cal-day-title");
  const calSlotsEl = document.getElementById("cal-slots");
  const calBlocksTitleEl = document.getElementById("cal-blocks-title");
  const calBlocksEl = document.getElementById("cal-blocks");

  const tlWrapEl = document.getElementById("cal-timeline-wrap");
  const tlScaleEl = document.getElementById("cal-timeline-scale");
  const tlBarEl = document.getElementById("cal-timeline-bar");
  const tipEl = document.getElementById("tl-tip");
  const tipCloseEl = document.getElementById("tl-tip-close");
  const tipTitleEl = document.getElementById("tl-tip-title");
  const tipTimeEl = document.getElementById("tl-tip-time");
  const tipDurEl = document.getElementById("tl-tip-dur");

  let publicEvents = [];
  let publicCalendarState = "unknown";
  let calCursor = new Date();
  let calSelectedISO = null;
  let lastPayload = null;
  let holidayByYear = new Map();

  const HOLIDAY_COUNTRY = "DE";
  const HOLIDAY_COUNTY = "DE-MV";
  const HOLIDAY_API_BASE = "https://date.nager.at/api/v3/PublicHolidays";

  function pad2(n){ return String(n).padStart(2,"0"); }
  function fmtTime(h){ return `${pad2(h)}:00`; }
  function setError(msg){
    errEl.style.display = msg ? "block" : "none";
    errEl.textContent = msg || "";
  }
  function setCtaStatus(msg){
    if(!ctaStatusEl) return;
    ctaStatusEl.textContent = msg || "";
  }
  function rangesOverlap(aStart,aEnd,bStart,bEnd){
    return aStart < bEnd && bStart < aEnd;
  }
  
  // Diese Funktion sorgt dafür, dass das Datum fehlerfrei im korrekten lokalen Format umgewandelt wird
  function calToISODate(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${dd}`;
  }
  
  function fmtHM(ms){
    const d = new Date(ms);
    return d.toLocaleTimeString("de-DE", { hour:"2-digit", minute:"2-digit" });
  }
  function fmtDuration(ms){
    const totalMin = Math.max(0, Math.round(ms / 60000));
    const h = Math.floor(totalMin / 60);
    const m = totalMin % 60;
    if(m === 0) return `${h}h`;
    return `${h}h ${m}min`;
  }
  function escapeText(s){
    return String(s || "").replace(/\\s+/g, " ").trim();
  }

  // Korrigiertes getTodayISO() für die sichere lokale Datums-Ermittlung
  async function getTodayISO(){
    return calToISODate(new Date());
  }

  async function setTodayDate(){
    try {
      const todayISO = await getTodayISO();
      dateEl.value = todayISO;
      calSelectedISO = todayISO;
    } catch(e) {}
  }

  async function loadPublicCalendar(){
    try{
      const res = await fetch(PUBLIC_CAL_URL, { cache: "no-store" });
      if(!res.ok) throw new Error("fetch failed");
      const data = await res.json();
      const ev = Array.isArray(data?.events) ? data.events : [];
      publicEvents = ev
        .filter(e => e && BLOCK_STATUSES.has(String(e.status)))
        .map(e => ({
          status: String(e.status),
          startMs: new Date(e.start).getTime(),
          endMs: new Date(e.end).getTime()
        }))
        .filter(e => Number.isFinite(e.startMs) && Number.isFinite(e.endMs) && e.endMs > e.startMs);
      publicCalendarState = publicEvents.length ? "loaded" : "empty";
      publicPillEl.textContent = "";
    } catch(e){
      publicEvents = [];
      publicCalendarState = "failed";
      publicPillEl.textContent = "Kalender aktuell nicht verfügbar";
    }
  }

  function holidayAppliesToMV(h){
    if(!h) return false;
    if(h.global === true) return true;
    if(Array.isArray(h.counties) && h.counties.includes(HOLIDAY_COUNTY)) return true;
    return false;
  }

  async function loadHolidaysForYear(year){
    if(holidayByYear.has(year)) return;
    try{
      const res = await fetch(`${HOLIDAY_API_BASE}/${year}/${HOLIDAY_COUNTRY}`, { cache: "force-cache" });
      if(!res.ok) throw new Error();
      const data = await res.json();
      const map = new Map();
      if(Array.isArray(data)){
        for(const h of data){
          if(!holidayAppliesToMV(h)) continue;
          const iso = String(h.date || "").slice(0,10);
          const name = String(h.localName || h.name || "").trim();
          if(iso && name) map.set(iso, name);
        }
      }
      holidayByYear.set(year, map);
    } catch(e){
      holidayByYear.set(year, new Map());
    }
  }

  async function getSunsetLocal(dateISO){
    const res = await fetch(`https://api.sunrise-sunset.org/json?lat=${LAT}&lng=${LNG}&date=${dateISO}&formatted=0`);
    if (!res.ok) throw new Error();
    const data = await res.json();
    if (!data || data.status !== "OK") throw new Error();
    return new Date(data.results.sunset);
  }

  function floorToFullHour(ts){
    const d = new Date(ts);
    d.setMinutes(0,0,0);
    return d.getTime();
  }

  function computeAllowedStartHours(dateISO, sunsetLocal, durationHours){
    const lastStartTsExact = sunsetLocal.getTime() - (durationHours*60 + RETURN_BUFFER_MIN) * 60 * 1000;
    const lastStartTsHour = floorToFullHour(lastStartTsExact);
    const allowed = [];
    for(let h=HOURS_MIN; h<=HOURS_MAX; h++){
      const candidate = new Date(dateISO + "T00:00:00");
      candidate.setHours(h,0,0,0);
      if(candidate.getTime() <= lastStartTsHour) allowed.push(h);
    }
    return { allowed, lastStartTsHour };
  }

  function isBlockedByPublicEvents(startMs, endMs){
    for(const e of publicEvents){
      if(rangesOverlap(startMs, endMs, e.startMs, e.endMs)) return true;
    }
    return false;
  }

  function filterByBookings(dateISO, durationHours, hours){
    const ok = [];
    for(const h of hours){
      const start = new Date(dateISO + "T00:00:00");
      start.setHours(h,0,0,0);
      const startMs = start.getTime();
      const endMs = startMs + durationHours*60*60*1000;
      if(!isBlockedByPublicEvents(startMs, endMs)) ok.push(h);
    }
    return ok;
  }

  function setStartOptions(hours, preferredValue){
    startEl.innerHTML = "";
    if(!hours.length){
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "Keine Startzeit verfügbar";
      startEl.appendChild(opt);
      startEl.disabled = true;
      startEl.classList.add("input-error");
      return;
    }
    startEl.disabled = false;
    startEl.classList.remove("input-error");
    for(const h of hours){
      const v = fmtTime(h);
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v;
      startEl.appendChild(opt);
    }
    const canUsePreferred = preferredValue && [...startEl.options].some(o => o.value === preferredValue);
    startEl.value = canUsePreferred ? preferredValue : startEl.options[0].value;
  }

  function updateCtas(){
    const dateISO = dateEl.value;
    const pkgLabel = pkgEl.options[pkgEl.selectedIndex]?.textContent || "";
    const startVal = startEl.value || "";
    if(!dateISO || !startVal || startEl.disabled){
      selectedPillEl.textContent = "Auswahl: –";
      lastPayload = null;
      return;
    }
    const nameVal = escapeText(nameEl?.value);
    const emailVal = escapeText(emailEl?.value);
    const phoneVal = escapeText(phoneEl?.value);
    const msgVal = escapeText(messageEl?.value);
    
    // Checkbox-Status für Kopie auslesen
    const wantsCopy = copyCustomerEl?.checked ? "Ja" : "Nein";

    lastPayload = {
      SQF_name: nameVal,
      SQF_email: emailVal,
      SQF_phone: phoneVal,
      SQF_message: msgVal,
      SQF_date: dateISO,
      SQF_start: startVal,
      SQF_paket: pkgLabel,
      SQF_copyToCustomer: wantsCopy, // Neues Feld für den Server
      date: dateISO,
      start: startVal,
      paket: pkgLabel,
      source: "wm-pages",
      page: location.href
    };
    selectedPillEl.textContent = `Auswahl: ${dateISO} • ${pkgLabel} • ${startVal}`;
  }

  async function refresh(){
    setError("");
    hintEl.textContent = "";
    sunsetPillEl.textContent = "";
    setCtaStatus("");
    const dateISO = dateEl.value;
    const duration = Number(pkgEl.value);
    if(!dateISO){
      setStartOptions([], "");
      hintEl.textContent = "Bitte Datum auswählen.";
      updateCtas();
      return;
    }
    try{
      const sunset = await getSunsetLocal(dateISO);
      const previouslySelected = startEl.value;
      const { allowed, lastStartTsHour } = computeAllowedStartHours(dateISO, sunset, duration);
      const filtered = filterByBookings(dateISO, duration, allowed);
      setStartOptions(filtered, previouslySelected);
      const sunsetText = sunset.toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"});
      sunsetPillEl.textContent = `Sonnenuntergang: ca. ${sunsetText} Uhr`;
      const lastStart = new Date(lastStartTsHour);
      const lastStartText = lastStart.toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"});
      if(filtered.length === 0){
        hintEl.textContent = `Keine Startzeit verfügbar (bereits belegt oder zu spät).`;
      } else {
        hintEl.textContent = `Letzter möglicher Start (volle Stunde) für dieses Paket: ${lastStartText} Uhr (inkl. 30 Min Rückgabe-Puffer).`;
      }
      updateCtas();
    } catch(e){
      setStartOptions([], "");
      updateCtas();
    }
  }

  function validateRequiredFields(){
    let isValid = true;
    let firstErrorEl = null;

    [nameEl, emailEl, phoneEl, dateEl, pkgEl, startEl].forEach(el => {
      if(el) el.classList.remove("input-error");
    });
    privacyEl.style.outline = "none";

    const checkField = (el, condition, msg) => {
      if(!el) return;
      if(!condition){
        el.classList.add("input-error");
        if(!firstErrorEl) {
          firstErrorEl = el;
          setError(msg);
        }
        isValid = false;
      }
    };

    checkField(nameEl, nameEl.value.trim() !== "", "Bitte Name eingeben.");
    checkField(emailEl, emailEl.value.includes("@") && emailEl.value.includes("."), "Bitte gültige E-Mail eingeben.");
    checkField(phoneEl, phoneEl.value.trim() !== "", "Bitte Telefonnummer eingeben.");
    checkField(dateEl, dateEl.value !== "", "Bitte Datum auswählen.");
    
    if(startEl && startEl.disabled) {
      startEl.classList.add("input-error");
      if(!firstErrorEl) {
         firstErrorEl = startEl;
         setError("Bitte Datum/Paket so wählen, dass eine Startzeit verfügbar ist.");
      }
      isValid = false;
    }

    if(!privacyEl.checked) {
      privacyEl.style.outline = "2px solid var(--c-error)";
      privacyEl.style.outlineOffset = "2px";
      if(!firstErrorEl) {
        firstErrorEl = privacyEl;
        setError("Bitte stimmen Sie der Datenschutzerklärung zu.");
      }
      isValid = false;
    }

    if(!isValid && firstErrorEl) {
      firstErrorEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
      firstErrorEl.focus();
    } else {
      setError("");
    }

    return isValid;
  }

  [nameEl, emailEl, phoneEl, dateEl].forEach(el => {
    el?.addEventListener("input", () => {
      el.classList.remove("input-error");
      if(errEl.style.display === "block") setError("");
    });
  });
  
  privacyEl?.addEventListener("change", () => {
    privacyEl.style.outline = "none";
    if(errEl.style.display === "block") setError("");
  });
  
  copyCustomerEl?.addEventListener("change", updateCtas);

  async function submitReservation(){
    if(!validateRequiredFields()) return;
    updateCtas();
    
    const oldText = ctaEl.textContent;
    ctaEl.disabled = true;
    ctaEl.textContent = "Wird gesendet…";
    setCtaStatus("");
    
    try{
      const res = await fetch(WORKERURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(lastPayload)
      });
      if(res.ok){
        ctaEl.textContent = "Erfolgreich gesendet ✓";
        setCtaStatus("Vielen Dank! Ihre Anfrage wurde versendet.");
        nameEl.value = ""; emailEl.value = ""; phoneEl.value = ""; messageEl.value = ""; privacyEl.checked = false; copyCustomerEl.checked = false;
        setTimeout(() => { ctaEl.textContent = oldText; }, 4000);
        return;
      }
      throw new Error(`Serverfehler`);
    } catch(e){
      setError("Senden fehlgeschlagen. Bitte überprüfen Sie Ihre Internetverbindung oder nutzen Sie das Kontaktformular.");
      ctaEl.textContent = oldText;
    } finally {
      ctaEl.disabled = false;
    }
  }

  function isAllDayLike(startMs, endMs){
    const s = new Date(startMs);
    const e = new Date(endMs);
    return s.getHours() === 0 && s.getMinutes() === 0 && (e.getHours() === 23 && (e.getMinutes() === 59 || e.getMinutes() === 0));
  }

  function getBlocksForDay(dayISO){
    const dayStart = new Date(dayISO + "T00:00:00").getTime();
    const dayEnd = new Date(dayISO + "T23:59:59").getTime();
    return publicEvents
      .filter(e => rangesOverlap(dayStart, dayEnd, e.startMs, e.endMs))
      .map(e => ({ status: e.status, startMs: Math.max(e.startMs, dayStart), endMs: Math.min(e.endMs, dayEnd) }))
      .sort((a,b) => a.startMs - b.startMs);
  }

  function renderBlocksList(dayISO){
    const blocks = getBlocksForDay(dayISO);
    calBlocksEl.innerHTML = "";
    if(!blocks.length){ calBlocksTitleEl.textContent = ""; return; }
    calBlocksTitleEl.textContent = "Belegungen an diesem Tag:";
    for(const b of blocks){
      const row = document.createElement("div");
      row.className = "muted";
      row.style.fontWeight = "800";
      row.style.marginTop = "6px";
      const label = b.status === "confirmed" ? "Gebucht" : "Reserviert";
      const allDay = isAllDayLike(b.startMs, b.endMs);
      const dur = fmtDuration(b.endMs - b.startMs);
      row.textContent = allDay ? `${label}: Ganztag (${dur})` : `${label}: ${fmtHM(b.startMs)}–${fmtHM(b.endMs)} (${dur})`;
      calBlocksEl.appendChild(row);
    }
  }

  function tipClose(){
    tipEl?.classList.remove("open");
    tipEl?.removeAttribute("data-pinned");
  }

  function tipOpenAt(x, y, title, timeText, durText, pin){
    if(!tipEl) return;
    tipTitleEl.textContent = title; tipTimeEl.textContent = timeText; tipDurEl.textContent = durText;
    const barRect = tlBarEl.getBoundingClientRect();
    let left = Math.max(8, Math.min(x - barRect.left + 10, barRect.width - 20));
    let top = Math.max(8, Math.min(y - barRect.top + 16, barRect.height + 10));
    tipEl.style.left = left + "px"; tipEl.style.top = top + "px"; tipEl.classList.add("open");
    if(pin) tipEl.setAttribute("data-pinned","1"); else tipEl.removeAttribute("data-pinned");
  }

  function renderTimeline(dayISO){
    const blocks = getBlocksForDay(dayISO);
    tlScaleEl.innerHTML = "";
    [TL_START_HOUR, TL_START_HOUR+3, TL_START_HOUR+6, TL_END_HOUR].forEach(h => {
      const sp = document.createElement("span"); sp.textContent = `${pad2(h)}:00`; tlScaleEl.appendChild(sp);
    });
    tlBarEl.querySelectorAll(".tl-block").forEach(n => n.remove());
    tipClose();
    const rangeStart = new Date(dayISO + "T00:00:00").setHours(TL_START_HOUR,0,0,0);
    const rangeEnd = new Date(dayISO + "T00:00:00").setHours(TL_END_HOUR,0,0,0);
    const range = Math.max(1, rangeEnd - rangeStart);
    tlWrapEl.style.display = "block";
    blocks.forEach(b => {
      const s = Math.max(b.startMs, rangeStart); const e = Math.min(b.endMs, rangeEnd);
      if(e <= s) return;
      const div = document.createElement("div");
      div.className = "tl-block " + (b.status === "confirmed" ? "conf" : "res");
      div.style.left = `${((s - rangeStart) / range) * 100}%`;
      div.style.width = `${Math.max(0.8, ((e - s) / range) * 100)}%`;
      const label = b.status === "confirmed" ? "Gebucht" : "Reserviert";
      const timeText = `${fmtHM(b.startMs)}–${fmtHM(b.endMs)}`;
      const durText = `Dauer: ${fmtDuration(b.endMs - b.startMs)}`;
      div.addEventListener("mousemove", (ev) => { if(tipEl?.getAttribute("data-pinned") !== "1") tipOpenAt(ev.clientX, ev.clientY, label, timeText, durText, false); });
      div.addEventListener("mouseleave", () => { if(tipEl?.getAttribute("data-pinned") !== "1") tipClose(); });
      div.addEventListener("click", (ev) => { ev.stopPropagation(); tipOpenAt(ev.clientX, ev.clientY, label, timeText, durText, true); });
      tlBarEl.appendChild(div);
    });
  }

  function countBlocksOnDay(iso){
    const aStart = new Date(iso + "T00:00:00").getTime(), aEnd = new Date(iso + "T23:59:59").getTime();
    let reserved = 0, confirmed = 0;
    for(const e of publicEvents){
      if(rangesOverlap(aStart, aEnd, e.startMs, e.endMs)){
        if(e.status === "confirmed") confirmed++; else if(e.status === "reserved") reserved++;
      }
    }
    return { reserved, confirmed };
  }

  function buildSlotButtons(dayISO, hours){
    calSlotsEl.innerHTML = "";
    if(!hours.length){
      const span = document.createElement("span"); span.className = "muted"; span.textContent = "Keine freien Startzeiten an diesem Tag."; calSlotsEl.appendChild(span);
      return;
    }
    hours.forEach(h => {
      const btn = document.createElement("button"); btn.type = "button"; btn.className = "btn2"; btn.textContent = fmtTime(h);
      btn.addEventListener("click", async () => {
        calSelectedISO = dayISO; dateEl.value = dayISO; await refresh();
        startEl.value = fmtTime(h); updateCtas();
        selectedPillEl?.scrollIntoView({behavior:"smooth", block:"center"});
      });
      calSlotsEl.appendChild(btn);
    });
  }

  async function showDaySlots(dayISO){
    calDayTitleEl.textContent = `Freie Startzeiten am ${dayISO} (für das ausgewählte Paket):`;
    calSlotsEl.innerHTML = "";
    try{
      const sunset = await getSunsetLocal(dayISO);
      const duration = Number(pkgEl.value);
      const { allowed } = computeAllowedStartHours(dayISO, sunset, duration);
      buildSlotButtons(dayISO, filterByBookings(dayISO, duration, allowed));
    } catch(e){
      const span = document.createElement("span"); span.className = "muted"; span.textContent = "Konnte nicht berechnet werden."; calSlotsEl.appendChild(span);
    }
    renderBlocksList(dayISO); renderTimeline(dayISO);
  }

  async function renderCalendar(){
    const year = calCursor.getFullYear(), month = calCursor.getMonth();
    await loadHolidaysForYear(year);
    const holidayMap = holidayByYear.get(year) || new Map();
    if(calTitleEl) calTitleEl.textContent = calCursor.toLocaleDateString("de-DE", { month:"long", year:"numeric" });
    const firstDow = (new Date(year, month, 1).getDay() + 6) % 7;
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const todayMs = new Date(new Date().setHours(0,0,0,0)).getTime();
    const todayISO = await getTodayISO(); // Nutzt die sichere lokale Version
    
    const grid = document.createElement("div");
    grid.style.display = "grid"; grid.style.gridTemplateColumns = "repeat(7, minmax(0, 1fr))"; grid.style.gap = "8px";
    ["Mo","Di","Mi","Do","Fr","Sa","So"].forEach(d => {
      const h = document.createElement("div"); h.className = "muted"; h.style.textAlign = "center"; h.style.fontWeight = "800"; h.textContent = d; grid.appendChild(h);
    });
    for(let i=0; i<firstDow; i++){ const b = document.createElement("div"); b.style.minHeight = "54px"; grid.appendChild(b); }
    for(let day=1; day<=daysInMonth; day++){
      const d = new Date(year, month, day); d.setHours(0,0,0,0);
      const iso = calToISODate(d), isPast = d.getTime() < todayMs;
      const cell = document.createElement("button"); cell.type = "button";
      cell.style.cssText = `display:block; width:100%; text-align:left; border:1px solid var(--c-border); border-radius:12px; padding:8px; min-height:54px; background:#fff; cursor:${isPast?'not-allowed':'pointer'}; opacity:${isPast?'0.45':'1'};`;
      if(iso === todayISO) cell.style.background = "rgba(29,51,74,.06)";
      if(calSelectedISO === iso) { cell.style.outline = "3px solid rgba(29,51,74,.30)"; cell.style.outlineOffset = "2px"; }
      
      const num = document.createElement("div"); num.style.fontWeight = "800"; num.textContent = day; cell.appendChild(num);
      const hol = holidayMap.get(iso);
      if(hol){ const hEl = document.createElement("div"); hEl.className = "holiday-label"; hEl.textContent = hol; cell.appendChild(hEl); cell.title = hol; }
      
      const { reserved, confirmed } = countBlocksOnDay(iso);
      if(reserved || confirmed){
        const badge = document.createElement("div"); badge.className = "muted"; badge.style.cssText = "margin-top:4px; font-size:12px; font-weight:800;";
        const parts = []; if(confirmed) parts.push(`Gebucht: ${confirmed}`); if(reserved) parts.push(`Reserv.: ${reserved}`);
        badge.textContent = parts.join(" • "); cell.appendChild(badge);
      }
      cell.addEventListener("click", async () => {
        if(isPast) return;
        calSelectedISO = iso; await renderCalendar(); dateEl.value = iso; await refresh(); showDaySlots(iso);
      });
      grid.appendChild(cell);
    }
    calGridEl.innerHTML = ""; calGridEl.appendChild(grid);
  }

  // Event Listeners
  calPrevEl?.addEventListener("click", async () => { calCursor = new Date(calCursor.getFullYear(), calCursor.getMonth()-1, 1); await renderCalendar(); });
  calNextEl?.addEventListener("click", async () => { calCursor = new Date(calCursor.getFullYear(), calCursor.getMonth()+1, 1); await renderCalendar(); });
  calTodayEl?.addEventListener("click", async () => {
    const todayISO = await getTodayISO(); calCursor = new Date(todayISO + "T00:00:00"); calCursor.setDate(1); calCursor.setHours(0,0,0,0);
    calSelectedISO = todayISO; await renderCalendar(); dateEl.value = todayISO; await refresh(); showDaySlots(todayISO);
  });
  pkgEl?.addEventListener("change", async () => { await refresh(); if(calSelectedISO) showDaySlots(calSelectedISO); });
  dateEl.addEventListener("change", async () => {
    const iso = dateEl.value; if(!iso) return; calSelectedISO = iso;
    calCursor = new Date(iso + "T00:00:00"); calCursor.setDate(1); calCursor.setHours(0,0,0,0);
    await renderCalendar(); await refresh(); showDaySlots(iso);
  });
  startEl.addEventListener("change", updateCtas);
  ctaEl?.addEventListener("click", submitReservation);
  tipCloseEl?.addEventListener("click", tipClose);

  let resizeTimeout;
  function wmPostHeight(){
    const h = Math.max(
      document.documentElement.scrollHeight,
      document.body?.scrollHeight || 0,
      document.documentElement.offsetHeight,
      document.body?.offsetHeight || 0
    );
    window.parent?.postMessage({ type: "wm-iframe-height", height: h }, "https://warnowmoments.de");
    window.parent?.postMessage({ type: "wm-iframe-height", height: h }, "https://www.warnowmoments.de");
  }

  async function init(){
    try {
      await setTodayDate();
      const todayISO = dateEl.value || await getTodayISO();
      calCursor = new Date(todayISO + "T00:00:00"); calCursor.setDate(1); calCursor.setHours(0,0,0,0);
      
      await Promise.all([ loadPublicCalendar(), loadHolidaysForYear(new Date().getFullYear()) ]);
      await renderCalendar(); await refresh(); if(calSelectedISO) showDaySlots(calSelectedISO); updateCtas();
      
      if ("ResizeObserver" in window) {
        const ro = new ResizeObserver(() => {
          clearTimeout(resizeTimeout);
          resizeTimeout = setTimeout(wmPostHeight, 50);
        });
        ro.observe(document.documentElement);
      }
      wmPostHeight();
    } catch(e) {
      setError("Initialisierung fehlgeschlagen. Bitte Seite neu laden.");
    }
  }

  init();
})();
</script>

</body>
</html>